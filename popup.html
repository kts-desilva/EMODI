<!doctype html>
<html>

<head>
    <title>GTmetrix Analyzer</title>
    <link rel="stylesheet" href="main.css">
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .hidden {
            display: none;
        }
    </style>

</head>

<body onload="setInterval('emotionAn()',120000)">

    <div class="booth">
        <video id="video" width="400" height="300"></video>
        <a href="#" id="capture" class="booth-capture-button">Take Photo</a>
        <canvas id="canvas" width="400" height="300"></canvas>
        <img id="photo" name="exo.png" src="http://placekitten.com/g/400/300" alt="Photo of you">
        <a href="#" id="send" class="booth-capture-button" onclick="sendFunc()">Send Photo</a>
        <a href="#" id="upload" class="booth-capture-button" onclick="uploadFunc()">Upload Photo</a>
        <a href="#" id="tabs" class="booth-capture-button">Tab detail</a>
        <button data-toggle="modal" data-target="#resultModal">Click me</button>
    </div>

    <div class="hidden">
        <p>Posting to imgur...</p>
    </div>


    <script src="jquery.min.js"></script>
    <script src="photo.js"></script>

    <script type="text/javascript">

        var link = "";
        var mood = "";

        function emotionAn() {
            console.log("called me");
            captureFunc();
            setTimeout(sendFunc, 60000);
            uploadFunc();

        }

        function captureFunc() {
            var video = document.getElementById('video'),
                canvas = document.getElementById('canvas'),
                context = canvas.getContext('2d'),
                photo = document.getElementById('photo'),
                loc = "",
                vendorUrl = window.URL || window.webkitURL;
            context.drawImage(video, 0, 0, 400, 300);
            photo.setAttribute('src', canvas.toDataURL('image/png'));
            loc = photo.getAttribute('src');

        }

        function uploadFunc() {
            alert("ck");
            var extractToken = function (hash) {
                var match = hash.match(/access_token=(\w+)/);
                return !!match && match[1];
            };

            var $post = $('.post');
            var $msg = $('.hidden');
            var $img = $('img');

            localStorage.doUpload = true;
            localStorage.imageBase64 = $img.attr('src').replace(/.*,/, '');

            var token = 'de3b9ffc7adba2a';

            localStorage.doUpload = false;
            $post.hide();
            $msg.show();

            $.ajax({
                url: 'https://api.imgur.com/3/image',
                method: 'POST',
                headers: {
                    Authorization: 'Client-ID ' + token,
                    Accept: 'application/json'
                },
                data: {
                    image: localStorage.imageBase64,
                    type: 'base64'
                },
                success: function (result) {
                    var id = result.data.id;
                    console.log('https://imgur.com/gallery/' + id);
                    alert('https://imgur.com/gallery/' + id);
                    link = 'https://i.imgur.com/' + id + ".png";
                    //window.location = 'https://imgur.com/gallery/' + id;
                }
            });

        }
        /*$(function () {
            var extractToken = function(hash) {
                var match = hash.match(/access_token=(\w+)/);
                return !!match && match[1];
            };

            var $post = $('.post');
            var $msg = $('.hidden');
            var $img = $('img');

            $post.click(function() {
                localStorage.doUpload = true;
                localStorage.imageBase64 = $img.attr('src').replace(/.*,/, '');
            });

            //var loc=document.getElementById('test').getAttribute('src');
            var token = 'de3b9ffc7adba2a';
            if (token && JSON.parse(localStorage.doUpload)) {
                localStorage.doUpload = false;
                $post.hide();
                $msg.show();

                $.ajax({
                    url: 'https://api.imgur.com/3/image',
                    method: 'POST',
                    headers: {
                        Authorization: 'Client-ID ' + token,
                        Accept: 'application/json'
                    },
                    data: {
                        image: localStorage.imageBase64,
                        type: 'base64'
                    },
                    success: function(result) {
                        var id = result.data.id;
                        alert('https://imgur.com/gallery/' + id);
                        link='https://i.imgur.com/' + id+".png";
                        //window.location = 'https://imgur.com/gallery/' + id;
                    }
                });
            }
        });

*/
        function sendFunc() {
            var params = {
                // Request parameters
            };

            console.log("Emotion : " + link);
            alert(link);

            $.ajax({
                url: "https://westus.api.cognitive.microsoft.com/emotion/v1.0/recognize?" + $.param(params),
                beforeSend: function (xhrObj) {
                    // Request headers
                    xhrObj.setRequestHeader("Content-Type", "application/json");
                    xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key", "7ccdbdf92f2a4e17af8a17c0656fdcb5");
                },
                type: "POST",
                // Request body
                data: JSON.stringify({
                    "url": link
                }),
            })
                .done(function (data) {
                    console.log(data[0]["scores"]["anger"]);
                    console.log(data[0]["scores"]);
                    //alert(data);
                    var mm = data[0]["scores"]["anger"];
                    mood = "anger";
                    for (m in data[0]["scores"]) {
                        if (mm < data[0]["scores"][m]) {
                            mm = data[0]["scores"][m];
                            mood = m;
                        }
                    }
                    alert(mood);
                })
                .fail(function () {
                    alert("error");
                });

            var today = new Date();
            var dd = today.getDate();
            var mm = today.getMonth() + 1; //January is 0!
            var yyyy = today.getFullYear();

            if (dd < 10) {
                dd = '0' + dd
            }

            if (mm < 10) {
                mm = '0' + mm
            }

            var tdate = mm + '/' + dd + '/' + yyyy;

            var hh=today.getHours();
            var mm=today.getMinutes();
            var ttime=hh+":"+mm;
            var uid=localStorage.getItem("uid");
            var txt_emotion=localStorage.getItem("txt_emotion");

            var myData = { "action": "addData", "edate": tdate, "etime": ttime, "txt_emotion": txt_emotion, "img_emotion": mood, "uid": uid };
            

            $.ajax({
                url: "http://localhost/EMODI/EMODI/PHP/emotion.php",
                type: "POST",
                data: myData,
                success: function (res) {
                    alert(res + " " + (res == 'true'));
                    if (res === 'true') {
                        console.log("Successfully added ..");
                    }
                }
            });

        }



    </script>

</body>

</html>